{"version":3,"file":"_server.ts-CR5UjOgQ.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/search-videos/_server.ts.js"],"sourcesContent":["import { j as json } from \"../../../../chunks/index.js\";\nimport axios from \"axios\";\nconst youtubeEndpoint = \"https://www.youtube.com\";\nconst GetListByKeyword = async (keyword, moduleTitle, usedVideoIds, moduleIndex) => {\n  try {\n    const cleanKeyword = keyword.replace(/^Search \\d+:\\s*/i, \"\").trim();\n    const cleanModuleTitle = moduleTitle.replace(/^Module \\d+:\\s*/i, \"\").trim();\n    const searchQueries = [\n      cleanKeyword,\n      `${cleanKeyword} tutorial`,\n      cleanModuleTitle,\n      `${cleanModuleTitle} tutorial`\n    ];\n    let allVideos = [];\n    for (const query of searchQueries) {\n      try {\n        const endpoint = `${youtubeEndpoint}/results?search_query=${encodeURIComponent(query)}&sp=EgIQAQ%3D%3D&hl=en&gl=US`;\n        const response = await axios.get(endpoint, {\n          headers: {\n            \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36\",\n            \"Accept-Language\": \"en-US,en;q=0.9\",\n            \"Cookie\": \"PREF=hl=en&gl=US\"\n          },\n          timeout: 5e3\n        });\n        const ytInitialData = response.data.split(\"var ytInitialData = \")[1];\n        if (!ytInitialData) continue;\n        const dataString = ytInitialData.split(\"<\\/script>\")[0].slice(0, -1);\n        const data = JSON.parse(dataString);\n        const contents = data.contents?.twoColumnSearchResultsRenderer?.primaryContents?.sectionListRenderer?.contents;\n        if (!contents) continue;\n        for (const content of contents) {\n          if (!content.itemSectionRenderer?.contents) continue;\n          const videos = content.itemSectionRenderer.contents.filter((item) => item.videoRenderer).map((item) => {\n            const video = item.videoRenderer;\n            const lengthText = video.lengthText?.simpleText;\n            const durationInMinutes = parseFloat(formatDuration(lengthText));\n            return {\n              videoId: video.videoId,\n              videoUrl: `https://www.youtube.com/watch?v=${video.videoId}`,\n              title: video.title.runs[0].text,\n              description: video.descriptionSnippet?.runs[0]?.text || \"\",\n              length: durationInMinutes,\n              thumbnailUrl: video.thumbnail.thumbnails[0].url\n            };\n          }).filter(\n            (video) => video && // Ensure video exists\n            isEnglishVideo(video) && // Filter for English videos\n            !usedVideoIds.has(video.videoId) && // Check for duplicates using videoId\n            !allVideos.some((v) => v.videoId === video.videoId) && // Double-check against current results\n            video.length >= 3 && video.length <= 20\n          );\n          for (const video of videos) {\n            if (allVideos.length >= 3) break;\n            if (!allVideos.some((v) => v.videoId === video.videoId) && !usedVideoIds.has(video.videoId)) {\n              allVideos.push(video);\n              usedVideoIds.add(video.videoId);\n            }\n          }\n          if (allVideos.length >= 3) break;\n        }\n        if (allVideos.length >= 3) break;\n      } catch (error) {\n        console.error(\"Error fetching videos:\", error);\n      }\n    }\n    if (allVideos.length < 3) {\n      const lastResortQuery = `${cleanKeyword} how to`;\n      try {\n        const endpoint = `${youtubeEndpoint}/results?search_query=${encodeURIComponent(lastResortQuery)}&sp=EgIQAQ%3D%3D`;\n        const response = await axios.get(endpoint, {\n          headers: {\n            \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36\",\n            \"Accept-Language\": \"en-US,en;q=0.9\"\n          },\n          timeout: 5e3\n        });\n      } catch (error) {\n        console.error(\"Error in last resort search:\", error);\n      }\n    }\n    return allVideos.length > 0 ? allVideos.slice(0, 3) : Array(3).fill(createPlaceholderVideo());\n  } catch (error) {\n    console.error(\"Error in GetListByKeyword:\", error);\n    return Array(3).fill(createPlaceholderVideo());\n  }\n};\nconst formatDuration = (durationText) => {\n  if (!durationText) return \"0\";\n  const parts = durationText.split(\":\").map(Number);\n  if (parts.length === 2) {\n    return (parts[0] + parts[1] / 60).toFixed(2);\n  } else if (parts.length === 3) {\n    return (parts[0] * 60 + parts[1] + parts[2] / 60).toFixed(2);\n  }\n  return \"0\";\n};\nconst createPlaceholderVideo = () => ({\n  videoId: \"\",\n  videoUrl: \"\",\n  title: \"No relevant video found\",\n  description: \"Please try regenerating the course or selecting a different topic.\",\n  length: 0,\n  thumbnailUrl: \"https://placehold.co/120x90/lightgray/darkgray.png?text=No+Video\"\n});\nfunction isEnglishVideo(video) {\n  const text = `${video.title} ${video.description}`.toLowerCase();\n  const nonEnglishIndicators = [\n    \"[한국어]\",\n    \"[日本語]\",\n    \"[中文]\",\n    \"[español]\",\n    \"[français]\",\n    \"[deutsch]\",\n    \"(한국어)\",\n    \"(日本語)\",\n    \"(中文)\",\n    \"(español)\",\n    \"(français)\",\n    \"(deutsch)\",\n    \"subtitles\",\n    \"субтитры\",\n    \"مترجم\",\n    \"字幕\"\n  ];\n  if (nonEnglishIndicators.some((indicator) => text.includes(indicator))) {\n    return false;\n  }\n  const latinCharRegex = /^[\\x00-\\x7F\\s]*$/;\n  const nonLatinCharPercentage = video.title.split(\"\").filter((char) => !latinCharRegex.test(char)).length / video.title.length;\n  return nonLatinCharPercentage < 0.15;\n}\nconst GET = async ({ url }) => {\n  const query = url.searchParams.get(\"query\")?.trim();\n  const moduleTitle = url.searchParams.get(\"moduleTitle\");\n  const moduleIndex = parseInt(url.searchParams.get(\"moduleIndex\") || \"0\");\n  if (!query) {\n    return new Response(JSON.stringify({\n      error: \"Query parameter is required\",\n      videos: Array(3).fill(createPlaceholderVideo())\n    }), {\n      status: 400,\n      headers: { \"Content-Type\": \"application/json\" }\n    });\n  }\n  try {\n    console.log(\"Searching videos for:\", { query, moduleTitle, moduleIndex });\n    const videos = await GetListByKeyword(query, moduleTitle || \"\", /* @__PURE__ */ new Set(), moduleIndex);\n    if (videos.every((v) => !v.videoId)) {\n      console.log(\"No videos found, retrying with simplified query...\");\n      const simplifiedQuery = query.split(\" \").slice(0, 3).join(\" \");\n      const retryVideos = await GetListByKeyword(simplifiedQuery, moduleTitle || \"\", /* @__PURE__ */ new Set(), moduleIndex);\n      return json({ videos: retryVideos });\n    }\n    return json({ videos });\n  } catch (error) {\n    console.error(\"Error fetching videos:\", error);\n    return json({\n      videos: Array(3).fill(createPlaceholderVideo())\n    });\n  }\n};\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}